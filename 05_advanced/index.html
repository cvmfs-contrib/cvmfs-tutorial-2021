
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.6">
    
    
      
        <title>5. Advanced topics - CernVM-FS tutorial</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.cb6bc1d0.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.39b8e14a.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#5-advanced-topics" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="CernVM-FS tutorial" class="md-header-nav__button md-logo" aria-label="CernVM-FS tutorial">
      
  <img src="../img/cvmfs_logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            CernVM-FS tutorial
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              5. Advanced topics
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/cvmfs-contrib/cvmfs-tutorial-2021/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    CernVM-FS tutorial
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="CernVM-FS tutorial" class="md-nav__button md-logo" aria-label="CernVM-FS tutorial">
      
  <img src="../img/cvmfs_logo.png" alt="logo">

    </a>
    CernVM-FS tutorial
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/cvmfs-contrib/cvmfs-tutorial-2021/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    CernVM-FS tutorial
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../00_azure_cloud_resources/" class="md-nav__link">
        0. Azure cloud resources
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../01_introduction/" class="md-nav__link">
        1. Introduction to CernVM-FS
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../02_stratum0_client/" class="md-nav__link">
        2. Stratum 0 and client
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../03_stratum1_proxies/" class="md-nav__link">
        3. Stratum 1 and proxies
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../04_publishing/" class="md-nav__link">
        4. Publishing
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          5. Advanced topics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        5. Advanced topics
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#51-automatic-deployment-of-cernvm-fs-servers-and-clients" class="md-nav__link">
    5.1 Automatic deployment of CernVM-FS servers and clients
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#52-debugging-issues" class="md-nav__link">
    5.2 Debugging issues
  </a>
  
    <nav class="md-nav" aria-label="5.2 Debugging issues">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#521-debugging-with-cvmfs_config" class="md-nav__link">
    5.2.1 Debugging with cvmfs_config
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#522-debugging-connection-issues" class="md-nav__link">
    5.2.2 Debugging connection issues
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#523-checking-the-logs-of-cernvm-fs-services" class="md-nav__link">
    5.2.3 Checking the logs of CernVM-FS services
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#53-garbage-collection" class="md-nav__link">
    5.3 Garbage collection
  </a>
  
    <nav class="md-nav" aria-label="5.3 Garbage collection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#531-setting-the-lifetime-of-automatically-generated-tags" class="md-nav__link">
    5.3.1 Setting the lifetime of automatically generated tags
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#532-cleaning-up-tags-marked-for-removal" class="md-nav__link">
    5.3.2 Cleaning up tags marked for removal
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#54-gateway-and-publishers" class="md-nav__link">
    5.4 Gateway and Publishers
  </a>
  
    <nav class="md-nav" aria-label="5.4 Gateway and Publishers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#541-gateway" class="md-nav__link">
    5.4.1 Gateway
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#542-publisher" class="md-nav__link">
    5.4.2 Publisher
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#55-mounting-cernvm-fs-repositories-as-an-unprivileged-user" class="md-nav__link">
    5.5 Mounting CernVM-FS repositories as an unprivileged user
  </a>
  
    <nav class="md-nav" aria-label="5.5 Mounting CernVM-FS repositories as an unprivileged user">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#551-singularity" class="md-nav__link">
    5.5.1 Singularity
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#552-cvmfsexec" class="md-nav__link">
    5.5.2 cvmfsexec
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#56-using-a-configuration-repository" class="md-nav__link">
    5.6 Using a configuration repository
  </a>
  
    <nav class="md-nav" aria-label="5.6 Using a configuration repository">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cvmfs-contrib" class="md-nav__link">
    cvmfs-contrib
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eessi" class="md-nav__link">
    EESSI
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#51-automatic-deployment-of-cernvm-fs-servers-and-clients" class="md-nav__link">
    5.1 Automatic deployment of CernVM-FS servers and clients
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#52-debugging-issues" class="md-nav__link">
    5.2 Debugging issues
  </a>
  
    <nav class="md-nav" aria-label="5.2 Debugging issues">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#521-debugging-with-cvmfs_config" class="md-nav__link">
    5.2.1 Debugging with cvmfs_config
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#522-debugging-connection-issues" class="md-nav__link">
    5.2.2 Debugging connection issues
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#523-checking-the-logs-of-cernvm-fs-services" class="md-nav__link">
    5.2.3 Checking the logs of CernVM-FS services
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#53-garbage-collection" class="md-nav__link">
    5.3 Garbage collection
  </a>
  
    <nav class="md-nav" aria-label="5.3 Garbage collection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#531-setting-the-lifetime-of-automatically-generated-tags" class="md-nav__link">
    5.3.1 Setting the lifetime of automatically generated tags
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#532-cleaning-up-tags-marked-for-removal" class="md-nav__link">
    5.3.2 Cleaning up tags marked for removal
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#54-gateway-and-publishers" class="md-nav__link">
    5.4 Gateway and Publishers
  </a>
  
    <nav class="md-nav" aria-label="5.4 Gateway and Publishers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#541-gateway" class="md-nav__link">
    5.4.1 Gateway
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#542-publisher" class="md-nav__link">
    5.4.2 Publisher
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#55-mounting-cernvm-fs-repositories-as-an-unprivileged-user" class="md-nav__link">
    5.5 Mounting CernVM-FS repositories as an unprivileged user
  </a>
  
    <nav class="md-nav" aria-label="5.5 Mounting CernVM-FS repositories as an unprivileged user">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#551-singularity" class="md-nav__link">
    5.5.1 Singularity
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#552-cvmfsexec" class="md-nav__link">
    5.5.2 cvmfsexec
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#56-using-a-configuration-repository" class="md-nav__link">
    5.6 Using a configuration repository
  </a>
  
    <nav class="md-nav" aria-label="5.6 Using a configuration repository">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cvmfs-contrib" class="md-nav__link">
    cvmfs-contrib
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eessi" class="md-nav__link">
    EESSI
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/cvmfs-contrib/cvmfs-tutorial-2021/edit/master/docs/05_advanced.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="5-advanced-topics">5. Advanced topics<a class="headerlink" href="#5-advanced-topics" title="Permanent link">&para;</a></h1>
<h2 id="51-automatic-deployment-of-cernvm-fs-servers-and-clients">5.1 Automatic deployment of CernVM-FS servers and clients<a class="headerlink" href="#51-automatic-deployment-of-cernvm-fs-servers-and-clients" title="Permanent link">&para;</a></h2>
<p>As you may have experienced during this tutorial, it takes quite a bit of manual effort to deploy all the different CernVM-FS components, and you can easily make mistakes.
Therefore, we strongly recommend to automate this in a production setup with a tool like <a href="https://www.ansible.com/">Ansible</a> or <a href="https://puppet.com/">Puppet</a>.</p>
<p>For Ansible, you could take a look at <a href="https://github.com/EESSI/filesystem-layer">the playbooks of the EESSI project</a>, which use <a href="https://github.com/galaxyproject/ansible-cvmfs">the Ansible role from the Galaxy Project</a> to install and configure both servers and clients.
Compute Canada also offers <a href="https://git.computecanada.ca/cc-cvmfs-public/ansible-cvmfs-client">an Ansible role</a> to configure CernVM-FS clients,
and a demo release of <a href="https://github.com/ComputeCanada/ansible-cvmfs-server">an Ansible role for Stratum servers</a>.</p>
<p>CERN offers <a href="https://github.com/cvmfs/puppet-cvmfs">its own Puppet module</a> that allows you to install and configure CernVM-FS servers and clients.</p>
<h2 id="52-debugging-issues">5.2 Debugging issues<a class="headerlink" href="#52-debugging-issues" title="Permanent link">&para;</a></h2>
<p>If you are experiencing issues with your CernVM-FS setup, there are various ways to start debugging.
Most issues are caused by wrongly configured clients (either a configuration issue, or a wrong public key)
and connection or firewall issues.</p>
<h3 id="521-debugging-with-cvmfs_config">5.2.1 Debugging with <code>cvmfs_config</code><a class="headerlink" href="#521-debugging-with-cvmfs_config" title="Permanent link">&para;</a></h3>
<p>In order to find the cause of the issue, you should first find out <em>where</em> the issue is being caused.
You can start by checking the client configuration:</p>
<div class="highlight"><pre><span></span><code>sudo cvmfs_config chksetup
</code></pre></div>
<p>This should print <code>OK</code>.</p>
<p>To make sure that your configuration is really picked up and set correctly
(because of the hierarchical structure of the configuration,
it is possible that some parameter gets overwritten by another configuration file),
you can dump the effective configuration for your repository:</p>
<div class="highlight"><pre><span></span><code>cvmfs_config showconfig repo.organization.tld
</code></pre></div>
<p>Make sure that at least <code>CVMFS_HTTP_PROXY</code> and <code>CVMFS_SERVER_URL</code> are set correctly, and that the directory pointed to by <code>CVMFS_KEYS_DIR</code> really contains the (correct) public key file.</p>
<p>The <code>probe</code> subcommand can be used for (re)trying to mount the repository, and should print <code>OK</code>:
<div class="highlight"><pre><span></span><code>$ cvmfs_config probe repo.organization.tld
Probing /cvmfs/repo.organization.tld... OK
</code></pre></div></p>
<p>However, since you are debugging a problem, it probably returns an error...</p>
<p>So, let's enable some debugging output by adding the following line to your <code>/etc/cvmfs/default.local</code>:
<div class="highlight"><pre><span></span><code>CVMFS_DEBUGLOG=/path/to/cvmfs.log
</code></pre></div></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Make sure that the <code>cvmfs</code> user has write permission to the location specified with <code>CVMFS_DEBUGLOG</code>.
Otherwise you will not only get no log file, but it will also lead to client failures.</p>
</div>
<p>Now we unmount the repository and try to probe it again, so that the configuration gets reloaded and the debug log gets created:</p>
<div class="highlight"><pre><span></span><code>sudo cvmfs_config umount
cvmfs_config probe repo.organization.tld
</code></pre></div>
<p>You can now check your debug log file, and look for any error messages near the bottom of the file; they may reveal more details about the issue.</p>
<h3 id="522-debugging-connection-issues">5.2.2 Debugging connection issues<a class="headerlink" href="#522-debugging-connection-issues" title="Permanent link">&para;</a></h3>
<p>If the problem turns out to be some kind of connection issue, you can trace it down further
by manually checking the connections from your client to the proxy and/or Stratum 1 server.</p>
<p>First, let's rule out that it is some kind of firewall issue by verifying that you can actually
connect to the appropriate ports on those servers:</p>
<div class="highlight"><pre><span></span><code>telnet &lt;PROXY_IP&gt; <span class="m">3128</span>
telnet &lt;STRATUM1_IP&gt; <span class="m">80</span>
</code></pre></div>
<p>If this does work, probably something is wrong with the services running on these machines.</p>
<p>Every CernVM-FS repository has a file named <code>.cvmfspublished</code>, and you can try to fetch it manually
using <code>curl</code>, both directly from the Stratum 1 and via your proxy:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Without your own proxy, so directly to the Stratum 1:</span>
curl --head http://&lt;STRATUM1_IP&gt;/cvmfs/repo.organization.tld/.cvmfspublished
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># With your caching proxy between the client and Stratum 1:</span>
curl --proxy http://&lt;PROXY_IP&gt;:3128 --head http://url-to-your-stratum1/cvmfs/repo.organization.tld/.cvmfspublished
</code></pre></div>
<p>These commands should return <code>HTTP/1.1 200 OK</code>. If the first command returns something else, you should inspect your CernVM-FS, Apache, and Squid configuration (and log) files on the Stratum 1 server. If the first <code>curl</code> command does work, but the second does not, there is something wrong with your Squid proxy; make sure that it is running, configured, and able to access your Stratum 1 server.</p>
<h3 id="523-checking-the-logs-of-cernvm-fs-services">5.2.3 Checking the logs of CernVM-FS services<a class="headerlink" href="#523-checking-the-logs-of-cernvm-fs-services" title="Permanent link">&para;</a></h3>
<p>Besides the client log file that we already explained, there are some other log files that you can inspect on the different servers.</p>
<p>On the Stratum 0, the main log files are the Apache access and error files, which you can find (on CentOS) in <code>/var/log/httpd</code>.</p>
<p>The Stratum 1 has several services, and, hence, several log files that can be of interest: just like on the Stratum 0, there are the Apache log files.
Besides those, also Squid has access and cache log files, which can be found in <code>/var/log/squid</code>.
The <code>cvmfs_server snapshot</code> commands will log to <code>/var/log/cvmfs/snapshots.log</code>.</p>
<p>Finally, the only relevant service on the proxy server is Squid itself, so <code>/var/log/squid</code> is again the place to find the log files.</p>
<h2 id="53-garbage-collection">5.3 Garbage collection<a class="headerlink" href="#53-garbage-collection" title="Permanent link">&para;</a></h2>
<p>As mentioned in <a href="../04_publishing/">the section about publishing</a>, the default configuration of a Stratum 0 enables automatic tagging,
which automatically assigns a timestamped tag to each published transaction.
However, by default, these automatically generated tags will not be removed automatically.
As a result, files that you remove in later transactions will still take up space in your repository...</p>
<h3 id="531-setting-the-lifetime-of-automatically-generated-tags">5.3.1 Setting the lifetime of automatically generated tags<a class="headerlink" href="#531-setting-the-lifetime-of-automatically-generated-tags" title="Permanent link">&para;</a></h3>
<p>Instead of removing tags manually, you can automatically mark these automatically generated tags for
removal after a certain period by setting the following variable
in the file <code>/etc/cvmfs/repositories.d/repo.organization.tld/server.conf</code> on your Stratum 0:
<div class="highlight"><pre><span></span><code>CVMFS_AUTO_TAG_TIMESPAN=&quot;30 days ago&quot;
</code></pre></div>
This should be a string that can be parsed by the <code>date</code> command, and defines the lifetime of the tags.</p>
<h3 id="532-cleaning-up-tags-marked-for-removal">5.3.2 Cleaning up tags marked for removal<a class="headerlink" href="#532-cleaning-up-tags-marked-for-removal" title="Permanent link">&para;</a></h3>
<p>In order to actually <em>clean up</em> unreferenced data, garbage collection has to be enabled for
the repository by adding <code>CVMFS_GARBAGE_COLLECTION=true</code> in the <code>server.conf</code> configuration file on Stratum 0.</p>
<p>The garbage collector of the CernVM-FS server can then be run using:</p>
<div class="highlight"><pre><span></span><code>sudo cvmfs_server gc repo.organization.tld
</code></pre></div>
<p>The <code>gc</code> subcommand has several options; a useful way to run it,
especially if you want to do this with a cron job, is:</p>
<div class="highlight"><pre><span></span><code>sudo cvmfs_server gc -a -l -f
</code></pre></div>
<p>The <code>-a</code> option will automatically run the garbage collection for all your repositories that have garbage collection enabled and log to <code>/var/log/cvmfs/gc.log</code>;
the <code>-l</code> option will make the command print which objects are actually removed;
and the <code>-f</code> option will not prompt for confirmation.</p>
<p>Note that you cannot run the garbage collection while a publish operation is ongoing.</p>
<h2 id="54-gateway-and-publishers">5.4 Gateway and Publishers<a class="headerlink" href="#54-gateway-and-publishers" title="Permanent link">&para;</a></h2>
<p>Only being able to modify your repository on the Stratum 0 server can be a bit limiting,
especially when multiple people have to maintain the repository.</p>
<p>A very recent feature of CernVM-FS allows you to set up so-called <em>publisher machines</em>,
which are separate systems that are allowed to modify the repository.
It also allows for setting up simple ACLs to let a system only access specific subtrees of the repository.</p>
<p>In order to use this feature you also need a <em>gateway machine</em> that has the repository storage mounted.
The easiest way to set it up is by having a single system that serves as both the
Stratum 0 and the gateway. This is the setup that we will explain here.</p>
<p>Do note that this is a fairly new feature and is not used a lot by production sites yet.
Therefore, use it at your own risk!</p>
<h3 id="541-gateway">5.4.1 Gateway<a class="headerlink" href="#541-gateway" title="Permanent link">&para;</a></h3>
<p><strong><em>Requirements</em></strong></p>
<p>The gateway system has the same requirements as a standard Stratum 0 server, except that it also needs
an additional port for the gateway service. This port is configurable, but by default port 4929 is used.</p>
<p><strong><em>Installation</em></strong></p>
<p>Perform the installation steps for the Stratum 0, which can be found in an
<a href="../02_stratum0_client/#212-installing-cernvm-fs">earlier section</a>.
Additionally, install the <code>cvmfs-gateway</code> package:</p>
<div class="highlight"><pre><span></span><code>sudo yum install -y cvmfs-gateway
</code></pre></div>
<p>Then create the repository <a href="../02_stratum0_client/#214-creating-the-repository">just like we did on Stratum 0</a>:</p>
<div class="highlight"><pre><span></span><code>sudo cvmfs_server mkfs -o <span class="nv">$USER</span> repo.organization.tld
</code></pre></div>
<p><strong><em>Configuration</em></strong></p>
<p>The gateway requires you to set up a configuration file <code>/etc/cvmfs/gateway/repo.json</code>.
This is a JSON file containing the name of the repository, the keys that can be used by publishers to get
access to the repository, and the (sub)path that these publishers are allowed to publish to.</p>
<p>The <code>cvmfs-gateway</code> package will make an example file for you, which you can edit or overwrite.
It should look like this:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nt">&quot;repos&quot;</span> <span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;domain&quot;</span> <span class="p">:</span> <span class="s2">&quot;repo.organization.tld&quot;</span><span class="p">,</span>
            <span class="nt">&quot;keys&quot;</span> <span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;keyid1&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;keyid2&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/restricted/to/subdir&quot;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;keys&quot;</span> <span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;plain_text&quot;</span><span class="p">,</span>
            <span class="nt">&quot;id&quot;</span> <span class="p">:</span> <span class="s2">&quot;keyid1&quot;</span><span class="p">,</span>
            <span class="nt">&quot;secret&quot;</span> <span class="p">:</span> <span class="s2">&quot;SOME_SECRET&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span> <span class="p">:</span> <span class="s2">&quot;plain_text&quot;</span><span class="p">,</span>
            <span class="nt">&quot;id&quot;</span> <span class="p">:</span> <span class="s2">&quot;keyid2&quot;</span><span class="p">,</span>
            <span class="nt">&quot;secret&quot;</span> <span class="p">:</span> <span class="s2">&quot;SOME_OTHER_SECRET&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p>You can choose the key IDs and secrets yourself; the secret has to be given to the owner of the
corresponding publisher machine.</p>
<p>Finally, there is a second configuration file <code>/etc/cvmfs/gateway/user.json</code>.
This is where you can, for instance, change the port of the gateway service and the maximum length of
an acquired lease. Assuming you do not have to change the port, you can leave it as it is.</p>
<p><strong><em>Starting the service</em></strong></p>
<p>To start the gateway service, use:</p>
<div class="highlight"><pre><span></span><code>systemctl start cvmfs-gateway
</code></pre></div>
<p>Note that once this service is running you should <em>not</em> open transactions on this Stratum 0 server anymore,
or you may corrupt the repository. If you do want to open a transaction, stop the gateway service first!</p>
<h3 id="542-publisher">5.4.2 Publisher<a class="headerlink" href="#542-publisher" title="Permanent link">&para;</a></h3>
<p><strong><em>Requirements</em></strong></p>
<p>There a no special requirements for a publisher system with respect to resources.</p>
<p><strong><em>Installation</em></strong></p>
<p>The publisher only needs to have the <code>cvmfs-server</code> package installed:
<div class="highlight"><pre><span></span><code>sudo yum install -y https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest.noarch.rpm
sudo yum install -y cvmfs-server
</code></pre></div></p>
<p><strong><em>Configuration</em></strong></p>
<p>The publisher machine only needs three files with keys:</p>
<ul>
<li>the repository's public master key: <code>repo.organization.tld.pub</code>;</li>
<li>the repository's public key encoded as X509 certificate: <code>repo.organization.tld.crt</code>;</li>
<li>the gateway API key stored in a file named <code>repo.organization.tld.gw</code>.</li>
</ul>
<p>The first two files can be taken from <code>/etc/cvmfs/keys</code> on your Stratum 0 server.
The latter can be created manually and should just contain the secret that was used in the gateway configuration.</p>
<p>All these files should be placed in some (temporary) directory on the publisher system.</p>
<p><strong><em>Creating the repository</em></strong></p>
<p>We can now create the repository available for writing on our publisher machine by running:</p>
<p><div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">S0_IP</span><span class="o">=</span><span class="s1">&#39;&lt;STRATUM0_IP&gt;&#39;</span>
sudo cvmfs_server mkfs -w http://<span class="nv">$S0_IP</span>/cvmfs/repo.organization.tld <span class="se">\</span>
                       -u gw,/srv/cvmfs/repo.organization.tld/data/txn,http://<span class="nv">$S0_IP</span>:4929/api/v1 <span class="se">\</span>
                       -k /path/to/keys/dir -o <span class="nv">$USER</span> repo.organization.tld
</code></pre></div>
Replace <code>&lt;STRATUM0_IP&gt;</code> with the IP address (or hostname) of your gateway / Stratum 0 server
(and change 4929 in case you changed the gateway port), and <code>/path/to/keys/dir</code> by the path where you
stored the keys in the previous step.</p>
<p><strong><em>Start publishing!</em></strong></p>
<p>You should now be able to make changes to the repository by starting a transaction:
<div class="highlight"><pre><span></span><code>cvmfs_server transaction repo.organization.tld
</code></pre></div></p>
<p>making some changes to the repository at <code>/cvmfs/repo.organization.tld</code>, and then publishing the changes:</p>
<div class="highlight"><pre><span></span><code>cvmfs_server publish repo.organization.tld
</code></pre></div>
<h2 id="55-mounting-cernvm-fs-repositories-as-an-unprivileged-user">5.5 Mounting CernVM-FS repositories as an unprivileged user<a class="headerlink" href="#55-mounting-cernvm-fs-repositories-as-an-unprivileged-user" title="Permanent link">&para;</a></h2>
<p>The default way of installing and configuring the CernVM-FS client requires you to have root privileges.
In case you want to use CernVM-FS repositories on systems where you do not have these, there are still some ways to install the client and mount repositories.
We will show two different methods: using a <a href="https://sylabs.io/singularity/">Singularity</a> container, and <a href="https://github.com/cvmfs/cvmfsexec">cvmfsexec</a>.</p>
<h3 id="551-singularity">5.5.1 Singularity<a class="headerlink" href="#551-singularity" title="Permanent link">&para;</a></h3>
<p>Recent versions of Singularity offer a <code>--fusemount</code> option that allow you to mount CernVM-FS repositories.
In order for this to work, you will need to install the <code>cvmfs</code> and <code>cvmfs-fuse3</code> package inside your container,
and add the right configuration files and public keys for the repositories.
Furthermore, you need two make two directories on the host system that will store the CernVM-FS cache and sockets;
these need to be made available via a bind mount inside the container at <code>/var/lib/cvmfs</code> and <code>/var/run/cvmfs</code>, respectively.</p>
<p>As an example, you can run the <a href="https://eessi.github.io/docs/pilot/#accessing-the-eessi-pilot-repository-through-singularity">EESSI pilot client container</a> (which was built using <a href="https://github.com/EESSI/filesystem-layer/blob/master/containers/Dockerfile.EESSI-client-pilot-centos7-x86_64">this Dockerfile</a>) using Singularity by doing:
<div class="highlight"><pre><span></span><code>mkdir -p /tmp/$USER/{var-lib-cvmfs,var-run-cvmfs}
export SINGULARITY_BIND=&quot;/tmp/$USER/var-run-cvmfs:/var/run/cvmfs,/tmp/$USER/var-lib-cvmfs:/var/lib/cvmfs&quot;
export EESSI_CONFIG=&quot;container:cvmfs2 cvmfs-config.eessi-hpc.org /cvmfs/cvmfs-config.eessi-hpc.org&quot;
export EESSI_PILOT=&quot;container:cvmfs2 pilot.eessi-hpc.org /cvmfs/pilot.eessi-hpc.org&quot;
singularity shell --fusemount &quot;$EESSI_CONFIG&quot; --fusemount &quot;$EESSI_PILOT&quot; docker://eessi/client-pilot:centos7-$(uname -m)
</code></pre></div></p>
<p>Note that you have to be careful when launching multiple containers on the same machine:
in this case, they all need a separate location for the cache, as it cannot be shared across containers.</p>
<h3 id="552-cvmfsexec">5.5.2 cvmfsexec<a class="headerlink" href="#552-cvmfsexec" title="Permanent link">&para;</a></h3>
<p>As an alternative, especially when Singularity is not available on your host system, you can try <a href="https://github.com/cvmfs/cvmfsexec">cvmfsexec</a>.
Depending on the availability of <code>fusermount</code> and user namespaces on the host system, it has several mechanisms for mounting CernVM-FS repositories,
either in a user's own file space or even under <code>/cvmfs</code>.</p>
<p>An advantage of this method is that the cache can be shared by several processes running on the same machines, even if you bind the mountpoint into multiple container instances.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This currently only works on RHEL 6/7/8 and its derivatives, and SUSE 15 and its derivatives.</p>
</div>
<p>Besides the <code>cvmfsexec</code> script itself, there is also a <code>singcvmfs</code> script that can be used to easily launch Singularity containers with a CernVM-FS mount;
this also uses the aforementiond <code>--fusemount</code> flag.
More information about this script can be found on the <a href="https://github.com/cvmfs/cvmfsexec#singcvmfs-command">README page of the <code>cvmfsexec</code> GitHub repository</a>.</p>
<h2 id="56-using-a-configuration-repository">5.6 Using a configuration repository<a class="headerlink" href="#56-using-a-configuration-repository" title="Permanent link">&para;</a></h2>
<p>In the <a href="../02_stratum0_client/#22-setting-up-a-client">first hands-on part of this tutorial</a> we have manually
configured our CernVM-FS client.</p>
<p>Although that was not very complicated, we did have to make sure that different things were
in the right place and properly named in order to successfully mount the repository.
We had to copy the public key of the repository under <code>/etc/cvmfs/key/&lt;domain&gt;</code>,
and create a configuration file in <code>/etc/cvmfs/config.d/&lt;reponame&gt;.&lt;domain&gt;.conf</code>
that specifies the location of the key
as well as the IP(s) of (eventually) the <a href="../03_stratum1_proxies/#331-connect-to-the-stratum-1">Stratum 1 servers</a>
that are available for this repository.</p>
<p>Next to the manual aspect, there is also a <strong>maintenance issue</strong> here: if the list of Stratum 1 servers
changes, for example if additional servers are added to the network,
we have know/remember to update our configuration file.</p>
<p>CernVM-FS provides an easy way to prevent these issues, by using a so-called
<a href="https://cvmfs.readthedocs.io/en/stable/cpt-configure.html#the-config-repository"><em>configuration repository</em></a>.
This is a standard CernVM-FS repository which is mounted under <code>/cvmfs</code>, and contains an <code>etc/cvmfs</code> subdirectory with the same structure as the regular <code>/etc/cvmfs</code>. It provides the
public keys and configuration of different CernVM-FS repositories, and it is updated automatically
when changes are made to it. So there is no more need for manually maintaining or updating for the
provided software repositories.</p>
<p>One limitation in CernVM-FS is that you can only use <em>one</em> configuration repository at a time.
If you want to mount additional software repositories for which the public key and configuration is
not included in the configuration repository you are using, you have to statically configure those repositories,
and maintain those configurations yourself somehow, either manually or by making sure you update
the package that provides the configuration.</p>
<h3 id="cvmfs-contrib"><code>cvmfs-contrib</code><a class="headerlink" href="#cvmfs-contrib" title="Permanent link">&para;</a></h3>
<p>Several CernVM-FS configuration repositories, which collect the public keys and configuration
for a couple of major organizations, are available via the <a href=""><code>cvmfs-contrib</code> GitHub organisation</a>;
see the <a href="https://cvmfs-contrib.github.io">website</a> and <a href="https://github.com/cvmfs-contrib/config-repo"><code>cvmfs-contrib/config-repo</code></a> GitHub repository.</p>
<p>Easy-to-install packages for different CernVM-FS configuration repositories are available via both a <code>yum</code> and <code>apt</code> repository.</p>
<h3 id="eessi">EESSI<a class="headerlink" href="#eessi" title="Permanent link">&para;</a></h3>
<p>The <a href="https://www.eessi-hpc.org/">EESSI project</a> also provides easy-to-install packages for
its CernVM-FS configuration repository, which are available through the <a href="https://github.com/EESSI/filesystem-layer/releases"><code>EESSI/filesystem-layer</code></a> GitHub repository.</p>
<p>For example, to install the EESSI CernVM-FS configuration repository on CentOS 7 or 8:</p>
<div class="highlight"><pre><span></span><code>sudo yum install -y https://github.com/EESSI/filesystem-layer/releases/download/v0.2.3/cvmfs-config-eessi-0.2.3-1.noarch.rpm
</code></pre></div>
<p>After installing this package, you will have the CernVM-FS configuration repository for EESSI available:</p>
<div class="highlight"><pre><span></span><code>$ ls /cvmfs/cvmfs-config.eessi-hpc.org/etc/cvmfs
contact  default.conf  domain.d  keys
</code></pre></div>
<p>And as a result, you can also access the EESSI pilot software repository at <code>/cvmfs/pilot.eessi-hpc.org</code>!</p>
                
                  
                    

<hr>
<div class="md-source-date">
  <small>
    
      Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">January 29, 2021</span>
    
  </small>
</div>
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../04_publishing/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                4. Publishing
              </div>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.53cc9318.min.js"></script>
      <script src="../assets/javascripts/bundle.e9c9f54f.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>