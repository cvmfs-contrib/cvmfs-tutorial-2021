
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.5">
    
    
      
        <title>3. Stratum 1 + proxies - CernVM-FS tutorial</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.15aa0b43.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.75751829.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#stratum-1-and-proxies" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="CernVM-FS tutorial" class="md-header-nav__button md-logo" aria-label="CernVM-FS tutorial">
      
  <img src="../img/cvmfs_logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            CernVM-FS tutorial
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              3. Stratum 1 + proxies
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/cvmfs-contrib/cvmfs-tutorial-2021/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    CernVM-FS tutorial
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="CernVM-FS tutorial" class="md-nav__button md-logo" aria-label="CernVM-FS tutorial">
      
  <img src="../img/cvmfs_logo.png" alt="logo">

    </a>
    CernVM-FS tutorial
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/cvmfs-contrib/cvmfs-tutorial-2021/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    CernVM-FS tutorial
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      


  
  
  
    <li class="md-nav__item">
      <a href="../00_azure_cloud_resources/" class="md-nav__link">
        0. Azure cloud resources
      </a>
    </li>
  

    
      
      
      


  
  
  
    <li class="md-nav__item">
      <a href="../01_introduction/" class="md-nav__link">
        1. Introduction to CernVM-FS
      </a>
    </li>
  

    
      
      
      


  
  
  
    <li class="md-nav__item">
      <a href="../02_stratum0_client/" class="md-nav__link">
        2. Stratum 0 + client
      </a>
    </li>
  

    
      
      
      


  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          3. Stratum 1 + proxies
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        3. Stratum 1 + proxies
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#set-up-a-stratum-1-server" class="md-nav__link">
    Set up a Stratum 1 server
  </a>
  
    <nav class="md-nav" aria-label="Set up a Stratum 1 server">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apache-and-squid-configuration" class="md-nav__link">
    Apache and Squid configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dns-cache" class="md-nav__link">
    DNS cache
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-stratum-1-replica" class="md-nav__link">
    Create the Stratum 1 replica
  </a>
  
    <nav class="md-nav" aria-label="Create the Stratum 1 replica">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#remove-the-replica" class="md-nav__link">
    Remove the replica
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manually-synchronize-the-stratum-1" class="md-nav__link">
    Manually synchronize the Stratum 1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-cronjobs" class="md-nav__link">
    Make cronjobs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-up-a-proxy" class="md-nav__link">
    Set up a proxy
  </a>
  
    <nav class="md-nav" aria-label="Set up a proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requirements_1" class="md-nav__link">
    Requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation_1" class="md-nav__link">
    Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#starting-squid" class="md-nav__link">
    Starting Squid
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#client-configuration" class="md-nav__link">
    Client configuration
  </a>
  
    <nav class="md-nav" aria-label="Client configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connect-to-the-stratum-1" class="md-nav__link">
    Connect to the Stratum 1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-the-squid-proxy" class="md-nav__link">
    Use the Squid proxy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#homework" class="md-nav__link">
    Homework
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      


  
  
  
    <li class="md-nav__item">
      <a href="../04_publishing/" class="md-nav__link">
        4. Publishing
      </a>
    </li>
  

    
      
      
      


  
  
  
    <li class="md-nav__item">
      <a href="../05_advanced/" class="md-nav__link">
        5. Advanced topics
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#set-up-a-stratum-1-server" class="md-nav__link">
    Set up a Stratum 1 server
  </a>
  
    <nav class="md-nav" aria-label="Set up a Stratum 1 server">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apache-and-squid-configuration" class="md-nav__link">
    Apache and Squid configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dns-cache" class="md-nav__link">
    DNS cache
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-stratum-1-replica" class="md-nav__link">
    Create the Stratum 1 replica
  </a>
  
    <nav class="md-nav" aria-label="Create the Stratum 1 replica">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#remove-the-replica" class="md-nav__link">
    Remove the replica
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manually-synchronize-the-stratum-1" class="md-nav__link">
    Manually synchronize the Stratum 1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-cronjobs" class="md-nav__link">
    Make cronjobs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-up-a-proxy" class="md-nav__link">
    Set up a proxy
  </a>
  
    <nav class="md-nav" aria-label="Set up a proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requirements_1" class="md-nav__link">
    Requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation_1" class="md-nav__link">
    Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#starting-squid" class="md-nav__link">
    Starting Squid
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#client-configuration" class="md-nav__link">
    Client configuration
  </a>
  
    <nav class="md-nav" aria-label="Client configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connect-to-the-stratum-1" class="md-nav__link">
    Connect to the Stratum 1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-the-squid-proxy" class="md-nav__link">
    Use the Squid proxy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#homework" class="md-nav__link">
    Homework
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/cvmfs-contrib/cvmfs-tutorial-2021/edit/master/docs/03_stratum1_proxies.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="stratum-1-and-proxies">Stratum 1 and proxies<a class="headerlink" href="#stratum-1-and-proxies" title="Permanent link">&para;</a></h1>
<p>In the previous section we have set up a Stratum 0 server and a client that directly connects to the Stratum 0.
Although this worked fine, this setup is neither scalable, nor very reliable, nor secure: it is a single point of failure,
too open in terms of connectivity, and it will have to serve all possible clients on its own.</p>
<p>Therefore, this section will show how all these points can be addressed by adding one or more Stratum 1 servers and caching proxy servers. A Stratum 1 is a replica server that keeps mirrors of the repositories served by a Stratum 0.
It is basically a web server that periodically synchronizes the contents of the repositories,
and, in contrast to a Stratum 0 server, you can have multiple Stratum 1 servers.
It is recommended to have several ones that are geographically distributed, so that clients always have a nearby Stratum 1 server.
How many you need mostly depends on the distribution and number of clients, but often a few is already sufficient. More scalability can be added with proxies, which we will discuss later in this section.</p>
<p>INSERT IMAGE OF CVMFS INFRA HERE</p>
<h2 id="set-up-a-stratum-1-server">Set up a Stratum 1 server<a class="headerlink" href="#set-up-a-stratum-1-server" title="Permanent link">&para;</a></h2>
<h3 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permanent link">&para;</a></h3>
<p>A Stratum 1 servers has similar requirements as a Stratum 1 in terms of resources.</p>
<p>In addition to port 80, also port 8000 has to be accessible for a Stratum 1. Furthermore, you need a (free) license key for <a href="https://dev.maxmind.com/geoip/geoip2/geolite2/">Maxmind's Geo API</a>, which you can obtain by <a href="https://www.maxmind.com/en/geolite2/signup/">signing up for an account</a>.</p>
<h3 id="installation">Installation<a class="headerlink" href="#installation" title="Permanent link">&para;</a></h3>
<p>For the Stratum 1 you need to install the following packages:
<div class="highlight"><pre><span></span><code>sudo yum install -y https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest.noarch.rpm
sudo yum install -y epel-release
sudo yum install -y cvmfs-server
sudo yum install -y mod_wsgi
sudo yum install -y squid
</code></pre></div></p>
<h3 id="apache-and-squid-configuration">Apache and Squid configuration<a class="headerlink" href="#apache-and-squid-configuration" title="Permanent link">&para;</a></h3>
<p>We will be running Apache with a Squid frontend (reverse proxy); Apache will be listening internally on port 8080, while Squid needs to listen (externally) on port 80 and 8000, which are the default Stratum 1 ports.</p>
<p>For this we first edit <code>/etc/httpd/conf/httpd.conf</code> and change the default:
<div class="highlight"><pre><span></span><code>Listen 80
</code></pre></div>
to:
<div class="highlight"><pre><span></span><code>Listen 127.0.0.1:8080
</code></pre></div></p>
<p>Next, we replace the default contents of <code>/etc/squid/squid.conf:</code> with the following:
<div class="highlight"><pre><span></span><code>http_port 80 accel
http_port 8000 accel
http_access allow all
cache_peer 127.0.0.1 parent 8080 0 no-query originserver

acl CVMFSAPI urlpath_regex ^/cvmfs/[^/]*/api/
cache deny !CVMFSAPI

cache_mem 128 MB
</code></pre></div></p>
<p>Finally, we start and enable Apache and Squid:
<div class="highlight"><pre><span></span><code>sudo systemctl start httpd
sudo systemctl start squid
sudo systemctl enable httpd
sudo systemctl enable squid
</code></pre></div></p>
<h3 id="dns-cache">DNS cache<a class="headerlink" href="#dns-cache" title="Permanent link">&para;</a></h3>
<p>As a Stratum 1 server does a lot of DNS lookups, it is recommended to have a local DNS caching server on that same machine.
We will not discuss this topic any further here, but you can use <code>dnsmasq</code>, <code>bind</code>, or <code>systemd-resolved</code>.
See for instance (this tutorial)[https://geekflare.com/linux-server-local-dns-caching/] for setting up <code>systemd-resolved</code>.</p>
<h3 id="create-the-stratum-1-replica">Create the Stratum 1 replica<a class="headerlink" href="#create-the-stratum-1-replica" title="Permanent link">&para;</a></h3>
<p>With all the required components in place, we can now really set up our Stratum 1 replica server. We first add our Geo API key to the CernVM-FS server settings:
<div class="highlight"><pre><span></span><code>echo &#39;CVMFS_GEO_LICENSE_KEY=YOUR_KEY&#39; | sudo tee -a /etc/cvmfs/server.local
sudo chmod 600 /etc/cvmfs/server.local
</code></pre></div></p>
<p>We also need to have the public keys of all repositories we want to mirror to be available on our Stratum 1. This can be done by copying all the corresponding <code>.pub</code> files from <code>/etc/cvmfs/keys</code> on your Stratum 0 server to
<code>/etc/cvmfs/keys/organization.tld/</code> (note the extra level!) on your Stratum 1 server.</p>
<p>Now we make the replica by giving the URL to the repository on the Stratum 0 server (which is always like <code>http://host:port/cvmfs/repository</code>) and the path to the corresponding public key:
<div class="highlight"><pre><span></span><code>sudo cvmfs_server add-replica -o $USER http://YOUR_STRATUM0/cvmfs/repo.organization.tld /etc/cvmfs/keys/organization.tld/repo.organization.tld
</code></pre></div></p>
<h4 id="remove-the-replica">Remove the replica<a class="headerlink" href="#remove-the-replica" title="Permanent link">&para;</a></h4>
<p>If you ever want to remove the replica again, you can use the <code>rmfs</code> subcommand in the same way as on a Stratum 0:
<div class="highlight"><pre><span></span><code>sudo cvmfs_server rmfs repo.organization.tld
</code></pre></div></p>
<h3 id="manually-synchronize-the-stratum-1">Manually synchronize the Stratum 1<a class="headerlink" href="#manually-synchronize-the-stratum-1" title="Permanent link">&para;</a></h3>
<p>The Stratum 1 has been registered, so now we should try to do a first synchronization.
You can do this by running the following command:
<div class="highlight"><pre><span></span><code>cvmfs_server snapshot repo.organization.tld
</code></pre></div>
As there is not much in the repository yet, this should complete within a few seconds.</p>
<h3 id="make-cronjobs">Make cronjobs<a class="headerlink" href="#make-cronjobs" title="Permanent link">&para;</a></h3>
<p>Whenever you make changes to the repository, the changes have to be synchronized to all Stratum 1 servers. Furthermore, the Geo database has to be updated regularly.</p>
<p>Both tasks can be automated by setting up cronjobs that periodically run <code>cvmfs_server update-geodb</code> and <code>cvmfs_server snapshot -a</code>, where <code>-a</code> does the synchronization for all active repositories. This option will give an error if no log rotation has been configured for CernVM-FS, so we first have to create a file <code>/etc/logrotate.d/cvmfs</code> with the following contents:</p>
<div class="highlight"><pre><span></span><code>/var/log/cvmfs/*.log {
    weekly
    missingok
    notifempty
}
</code></pre></div>
<p>Now we can make a cronjob <code>/etc/cron.d/cvmfs_stratum1_snapshot</code> for the snapshots:</p>
<div class="highlight"><pre><span></span><code>*/5 * * * * root output=$(/usr/bin/cvmfs_server snapshot -a -i 2&gt;&amp;1) || echo &quot;$output&quot;
</code></pre></div>
<p>And another cronjob <code>/etc/cron.d/cvmfs_geoip_db_update</code> for updating the Geo database:
<div class="highlight"><pre><span></span><code>4 2 2 * * root /usr/bin/cvmfs_server update-geodb
</code></pre></div></p>
<h2 id="set-up-a-proxy">Set up a proxy<a class="headerlink" href="#set-up-a-proxy" title="Permanent link">&para;</a></h2>
<p>If you have a lot of local machines, e.g. a cluster, that need to access your repositories, you also want another cache layer close to these machines. This can be done by adding Squid proxies between your local machine(s) and the layer of Stratum 1 servers.
Usually it is recommended to have at least two of them for reliability and load-balancing reasons.</p>
<h3 id="requirements_1">Requirements<a class="headerlink" href="#requirements_1" title="Permanent link">&para;</a></h3>
<p>Just as with the other components, the squid proxy server does not need a lot of resources.
Just a few cores and few gigabytes of memory should be enough. The more disk space you allocate
for this machine, the larger the cache can be, and the better the performance will be. Do note that this machine will only store a part of the (deduplicated and compressed) repository, so it does not need as much space as your Stratum 1.</p>
<h3 id="installation_1">Installation<a class="headerlink" href="#installation_1" title="Permanent link">&para;</a></h3>
<p>The proxy server only requires Squid to be installed:
<div class="highlight"><pre><span></span><code>sudo yum install -y squid
</code></pre></div></p>
<h3 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h3>
<p>The configuration of a standalone Squid is slightly different from the one that we used for our Stratum 1. You can use the following template to set up your own configuration:</p>
<div class="highlight"><pre><span></span><code># List of local IP addresses (separate IPs and/or CIDR notation) allowed to access your local proxy
acl local_nodes src YOUR_CLIENT_IPS

# Destination domains that are allowed
#acl stratum_ones dstdomain .YOURDOMAIN.ORG
#acl stratum_ones dstdom_regex YOUR_REGEX

# Squid port (default: 3128)
# http_port 3128

# Deny access to anything which is not part of our stratum_ones ACL.
http_access deny !stratum_ones

# Only allow access from our local machines
http_access allow local_nodes
http_access allow localhost

# Finally, deny all other access to this proxy
http_access deny all

minimum_expiry_time 0
maximum_object_size 1024 MB

cache_mem 128 MB
maximum_object_size_in_memory 128 KB
# 50 GB disk cache
cache_dir ufs /var/spool/squid 50000 16 256
</code></pre></div>
<p>You should use the <code>local_nodes</code> ACL here to specify which clients are allowed to use this proxy; you can use <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#CIDR_notation">CIDR notation</a>.</p>
<p>Furthermore, you probably also want to have an ACL that specifies that your Squid should only cache the Stratum 1 servers. The template uses a <code>stratum_ones</code> ACL for this, and you can make use of either <code>dstdomain</code> (in case you have a single domain for all your Stratum 1 servers) or <code>dstdom_regex</code> for more complex situations.</p>
<p>More information about Squid ACLs can be found in the (Squid documentation)[http://www.squid-cache.org/Doc/config/acl/].</p>
<p>Finally, there are some settings regarding the size of your cache. Make sure that you have enough disk space for the value that you provide.</p>
<h3 id="starting-squid">Starting Squid<a class="headerlink" href="#starting-squid" title="Permanent link">&para;</a></h3>
<p>Before you actually start Squid, you can verify the correctness of your configuration with <code>sudo squid -k parse</code>. When you are sure things are okay, start and enable Squid:
<div class="highlight"><pre><span></span><code>sudo systemctl start squid
sudo systemctl enable squid
</code></pre></div></p>
<h2 id="client-configuration">Client configuration<a class="headerlink" href="#client-configuration" title="Permanent link">&para;</a></h2>
<p>Now that we have a Stratum 0, one ore more Stratum 1 servers, and one or more local Squid proxies, all the infrastructure for a production-ready CernVM-FS setup is in place. This means that we can now configure our client properly, and start using the repository.</p>
<p>In the previous section we connected our client directly to the Stratum 0. We are going to reuse that configuration, and only need to change two things.</p>
<h3 id="connect-to-the-stratum-1">Connect to the Stratum 1<a class="headerlink" href="#connect-to-the-stratum-1" title="Permanent link">&para;</a></h3>
<p>We used the URL of the Stratum 0 in the file <code>/etc/cvmfs/config.d/repo.organization.tld.conf</code>. We should now change this URL, and point to the Stratum 1 instead:
<div class="highlight"><pre><span></span><code>CVMFS_SERVER_URL=&quot;http://your-stratum1/cvmfs/@fqrn@&quot;
</code></pre></div></p>
<p>When you have more Stratum 1 servers inside the organization, you can make it a semicolon-separated list of servers. The Geo API will make sure that your client always connects to the geographically closest Stratum 1 server.</p>
<h3 id="use-the-squid-proxy">Use the Squid proxy<a class="headerlink" href="#use-the-squid-proxy" title="Permanent link">&para;</a></h3>
<p>In order to use the local cache layer of our proxy, we have to instruct the client to send all requests through the proxy. This needs one small change in <code>/etc/cvmfs/default.local</code>, where you will have to set:
<div class="highlight"><pre><span></span><code>CVMFS_HTTP_PROXY=&quot;http://your-proxy:3128&quot;
</code></pre></div></p>
<p>More proxies can be added to that list by separating them with a pipe symbol. See for more (complex) examples <a href="https://cvmfs.readthedocs.io/en/stable/cpt-configure.html#proxy-list-examples">this documentation page</a>.</p>
<h2 id="homework">Homework<a class="headerlink" href="#homework" title="Permanent link">&para;</a></h2>
<ul>
<li>Set up a Stratum 1 server. Make sure that it includes:</li>
<li>a proper Geo API license key;</li>
<li>cronjobs for automatically synchronizing the database and updating the Geo database;</li>
<li>properly configured Apache and Squid services;</li>
<li>Set up a separate Squid proxy. Though it is recommended to at least have two in production, one is enough for now.</li>
<li>
<h1 id="todo-reuse-or-set-up-a-new-client-add-firewall-rules-to-the-stratum-0">TODO: reuse or set up a new client?? Add firewall rules to the Stratum 0?<a class="headerlink" href="#todo-reuse-or-set-up-a-new-client-add-firewall-rules-to-the-stratum-0" title="Permanent link">&para;</a></h1>
  Reconfigure the client that you set up in the previous section and make sure that it uses your Stratum 1 and Squid proxy.</li>
</ul>
                
                  
                    

<hr>
<div class="md-source-date">
  <small>
    
      Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">January 19, 2021</span>
    
  </small>
</div>
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../02_stratum0_client/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                2. Stratum 0 + client
              </div>
            </div>
          </a>
        
        
          <a href="../04_publishing/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                4. Publishing
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.93c04032.min.js"></script>
      <script src="../assets/javascripts/bundle.83e5331e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>