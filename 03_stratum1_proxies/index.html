
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.6">
    
    
      
        <title>3. Stratum 1 and proxies - CernVM-FS tutorial</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.cb6bc1d0.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.39b8e14a.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#3-stratum-1-and-proxies" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="CernVM-FS tutorial" class="md-header-nav__button md-logo" aria-label="CernVM-FS tutorial">
      
  <img src="../img/cvmfs_logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            CernVM-FS tutorial
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              3. Stratum 1 and proxies
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/cvmfs-contrib/cvmfs-tutorial-2021/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    CernVM-FS tutorial
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="CernVM-FS tutorial" class="md-nav__button md-logo" aria-label="CernVM-FS tutorial">
      
  <img src="../img/cvmfs_logo.png" alt="logo">

    </a>
    CernVM-FS tutorial
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/cvmfs-contrib/cvmfs-tutorial-2021/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    CernVM-FS tutorial
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../00_azure_cloud_resources/" class="md-nav__link">
        0. Azure cloud resources
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../01_introduction/" class="md-nav__link">
        1. Introduction to CernVM-FS
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../02_stratum0_client/" class="md-nav__link">
        2. Stratum 0 and client
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          3. Stratum 1 and proxies
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        3. Stratum 1 and proxies
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#31-setting-up-the-stratum-1-server" class="md-nav__link">
    3.1 Setting up the Stratum 1 server
  </a>
  
    <nav class="md-nav" aria-label="3.1 Setting up the Stratum 1 server">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#311-requirements" class="md-nav__link">
    3.1.1 Requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#312-installation" class="md-nav__link">
    3.1.2 Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#313-configuring-apache-and-squid-proxy" class="md-nav__link">
    3.1.3 Configuring Apache and Squid proxy
  </a>
  
    <nav class="md-nav" aria-label="3.1.3 Configuring Apache and Squid proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apache-configuration" class="md-nav__link">
    Apache configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#squid-configuration" class="md-nav__link">
    Squid configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-enable-services" class="md-nav__link">
    Start &amp; enable services
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#314-dns-cache" class="md-nav__link">
    3.1.4 DNS cache
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#315-creating-the-stratum-1-replica" class="md-nav__link">
    3.1.5 Creating the Stratum 1 replica
  </a>
  
    <nav class="md-nav" aria-label="3.1.5 Creating the Stratum 1 replica">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-and-add-geo-api-key-optional" class="md-nav__link">
    Create and add Geo API key (optional)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-repository-master-public-key" class="md-nav__link">
    Add repository master public key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-replica" class="md-nav__link">
    Create replica
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bypassing-the-geo-api-license-key" class="md-nav__link">
    Bypassing the Geo API license key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-the-replica" class="md-nav__link">
    Remove the replica
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#316-manually-synchronize-the-stratum-1" class="md-nav__link">
    3.1.6 Manually synchronize the Stratum 1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#317-adding-a-synchronization-cron-job" class="md-nav__link">
    3.1.7 Adding a synchronization cron job
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#32-setting-up-a-proxy" class="md-nav__link">
    3.2 Setting up a proxy
  </a>
  
    <nav class="md-nav" aria-label="3.2 Setting up a proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321-requirements" class="md-nav__link">
    3.2.1 Requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-installation" class="md-nav__link">
    3.2.2 Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#323-configuration" class="md-nav__link">
    3.2.3 Configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#324-verifying-squid-configuration" class="md-nav__link">
    3.2.4 Verifying Squid configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#325-starting-and-enabling-squid" class="md-nav__link">
    3.2.5 Starting and enabling Squid
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#33-re-configuring-the-client" class="md-nav__link">
    3.3 Re-configuring the client
  </a>
  
    <nav class="md-nav" aria-label="3.3 Re-configuring the client">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#331-connect-to-the-stratum-1" class="md-nav__link">
    3.3.1 Connect to the Stratum 1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#332-use-the-squid-proxy" class="md-nav__link">
    3.3.2 Use the Squid proxy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#333-test-the-new-configuration" class="md-nav__link">
    3.3.3 Test the new configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise" class="md-nav__link">
    Exercise
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../04_publishing/" class="md-nav__link">
        4. Publishing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../05_advanced/" class="md-nav__link">
        5. Advanced topics
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#31-setting-up-the-stratum-1-server" class="md-nav__link">
    3.1 Setting up the Stratum 1 server
  </a>
  
    <nav class="md-nav" aria-label="3.1 Setting up the Stratum 1 server">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#311-requirements" class="md-nav__link">
    3.1.1 Requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#312-installation" class="md-nav__link">
    3.1.2 Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#313-configuring-apache-and-squid-proxy" class="md-nav__link">
    3.1.3 Configuring Apache and Squid proxy
  </a>
  
    <nav class="md-nav" aria-label="3.1.3 Configuring Apache and Squid proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apache-configuration" class="md-nav__link">
    Apache configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#squid-configuration" class="md-nav__link">
    Squid configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-enable-services" class="md-nav__link">
    Start &amp; enable services
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#314-dns-cache" class="md-nav__link">
    3.1.4 DNS cache
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#315-creating-the-stratum-1-replica" class="md-nav__link">
    3.1.5 Creating the Stratum 1 replica
  </a>
  
    <nav class="md-nav" aria-label="3.1.5 Creating the Stratum 1 replica">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-and-add-geo-api-key-optional" class="md-nav__link">
    Create and add Geo API key (optional)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-repository-master-public-key" class="md-nav__link">
    Add repository master public key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-replica" class="md-nav__link">
    Create replica
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bypassing-the-geo-api-license-key" class="md-nav__link">
    Bypassing the Geo API license key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-the-replica" class="md-nav__link">
    Remove the replica
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#316-manually-synchronize-the-stratum-1" class="md-nav__link">
    3.1.6 Manually synchronize the Stratum 1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#317-adding-a-synchronization-cron-job" class="md-nav__link">
    3.1.7 Adding a synchronization cron job
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#32-setting-up-a-proxy" class="md-nav__link">
    3.2 Setting up a proxy
  </a>
  
    <nav class="md-nav" aria-label="3.2 Setting up a proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321-requirements" class="md-nav__link">
    3.2.1 Requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-installation" class="md-nav__link">
    3.2.2 Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#323-configuration" class="md-nav__link">
    3.2.3 Configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#324-verifying-squid-configuration" class="md-nav__link">
    3.2.4 Verifying Squid configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#325-starting-and-enabling-squid" class="md-nav__link">
    3.2.5 Starting and enabling Squid
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#33-re-configuring-the-client" class="md-nav__link">
    3.3 Re-configuring the client
  </a>
  
    <nav class="md-nav" aria-label="3.3 Re-configuring the client">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#331-connect-to-the-stratum-1" class="md-nav__link">
    3.3.1 Connect to the Stratum 1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#332-use-the-squid-proxy" class="md-nav__link">
    3.3.2 Use the Squid proxy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#333-test-the-new-configuration" class="md-nav__link">
    3.3.3 Test the new configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercise" class="md-nav__link">
    Exercise
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/cvmfs-contrib/cvmfs-tutorial-2021/edit/master/docs/03_stratum1_proxies.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="3-stratum-1-and-proxies">3. Stratum 1 and proxies<a class="headerlink" href="#3-stratum-1-and-proxies" title="Permanent link">&para;</a></h1>
<p>In the previous section we have set up a Stratum 0 server and a client that directly connects to the Stratum 0.
Although this worked fine this is <em>not recommended</em>, since this setup is neither scalable, nor very reliable, nor secure:
it is a single point of failure, too open in terms of connectivity, and it will have to serve all clients on its own.</p>
<p>Therefore, we will show how all these points can be addressed by adding a <strong>Stratum 1 server</strong> and a <strong>caching proxy server</strong>.</p>
<p>Quick reminder: a Stratum 1 is a <em>replica server</em> that keeps <em>mirrors</em> of the repositories served by a Stratum 0.
It is a web server that periodically synchronizes the contents of the repositories.</p>
<p>In contrast to the central Stratum 0 server you can have <em>multiple</em> Stratum 1 servers,
and it is recommended to have them geographically distributed, so that clients always have a nearby Stratum 1.</p>
<p>How many Stratum 1 servers you need mostly depends on the number of clients and how they are
distributed geographically, but often a few is already sufficient.</p>
<p>Scalability and performance can be improved with proxies, which we will discuss later in this section.</p>
<p align="center">
<img src="../img/stratum1_proxy.png" alt="CernVM-FS - Stratum 1 + proxy" width="700px"/>
</p>

<h2 id="31-setting-up-the-stratum-1-server">3.1 Setting up the Stratum 1 server<a class="headerlink" href="#31-setting-up-the-stratum-1-server" title="Permanent link">&para;</a></h2>
<h3 id="311-requirements">3.1.1 Requirements<a class="headerlink" href="#311-requirements" title="Permanent link">&para;</a></h3>
<p>A Stratum 1 server has <a href="../02_stratum0_client/#211-requirements">similar requirements as a Stratum 0 in terms of resources</a>.</p>
<p>In addition to port 80 (for the Apache web server), port 8000 also has to be accessible for a Stratum 1
(for the Squid proxy frontend). </p>
<p>Furthermore, you need a (free) license key for <a href="https://dev.maxmind.com/geoip/geoip2/geolite2/">Maxmind's Geo API</a>,
which you can obtain by <a href="https://www.maxmind.com/en/geolite2/signup/">signing up for an account</a>. This is used
by CernVM-FS to allow clients to determine which Stratum 1 server is geographically located closest.</p>
<h3 id="312-installation">3.1.2 Installation<a class="headerlink" href="#312-installation" title="Permanent link">&para;</a></h3>
<p>For the Stratum 1 you need to install the following packages:</p>
<div class="highlight"><pre><span></span><code>sudo yum install -y epel-release  <span class="c1"># not needed on CentOS 8</span>
sudo yum install -y https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest.noarch.rpm
sudo yum install -y cvmfs-server squid
sudo yum install -y mod_wsgi <span class="c1"># on CentOS 7</span>
<span class="c1"># sudo yum install -y python3-mod_wsgi  # on CentOS 8</span>
</code></pre></div>
<p>This is:</p>
<ul>
<li><code>cvmfs-server</code>: the CermVM-FS server package (just like for Stratum 0);</li>
<li><code>mod_wsgi</code>: an Apache module that provides a WSGI compliant
  interface for hosting Python based web applications within Apache,
  which is required by CernVM-FS to query the Geo API (more on that later);</li>
<li><code>squid</code>: the Squid proxy package.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The Squid package in the official CentOS 7 repository is version 3.5.20, <strong>which is <a href="https://wiki.squid-cache.org/Squid-3.5">deprecated</a></strong>.
It is not recommended to use this version in production systems.
Squid 4 packages for CentOS 7 can be found in other repositories,
see the <a href="https://wiki.squid-cache.org/SquidFaq/BinaryPackages#CentOS">Binary packages page on the Squid website</a>.</p>
</div>
<h3 id="313-configuring-apache-and-squid-proxy">3.1.3 Configuring Apache and Squid proxy<a class="headerlink" href="#313-configuring-apache-and-squid-proxy" title="Permanent link">&para;</a></h3>
<p>On the Stratum 1, we will be running Apache with a Squid frontend (reverse proxy).
Squid is mainly used to cache the calls to the Geo API, and it can also be helpful for setting up joint monitoring
(for instance, see <a href="http://wlcg-squid-monitor.cern.ch/">the monitoring page of the Worldwide LHC Computing Grid project</a>).
We will be setting up a single Squid reverse proxy, but you could even have a load balancer that spreads the load over multiple instances.</p>
<p>The Apache web server will be listening internally on port 8080,
while the Squid proxy will be set up to listen (externally) on port 80 and 8000. 
Port 80 is the default HTTP port, and port 8000 is a somewhat de facto standard commonly used for CernVM-FS Stratum 1 servers.</p>
<h4 id="apache-configuration">Apache configuration<a class="headerlink" href="#apache-configuration" title="Permanent link">&para;</a></h4>
<p>First, we modify the Apache webserver configuration, by editing <code>/etc/httpd/conf/httpd.conf</code> and change the default:
<div class="highlight"><pre><span></span><code>Listen 80
</code></pre></div>
to:
<div class="highlight"><pre><span></span><code>Listen 127.0.0.1:8080
</code></pre></div></p>
<h4 id="squid-configuration">Squid configuration<a class="headerlink" href="#squid-configuration" title="Permanent link">&para;</a></h4>
<p>Next, we replace the default contents of <code>/etc/squid/squid.conf</code> with the following:
<div class="highlight"><pre><span></span><code>http_port 80 accel
http_port 8000 accel
http_access allow all
cache_peer 127.0.0.1 parent 8080 0 no-query originserver

acl CVMFSAPI urlpath_regex ^/cvmfs/[^/]*/api/
cache deny !CVMFSAPI

cache_mem 128 MB
</code></pre></div></p>
<p>To clarify:</p>
<ul>
<li><a href="http://www.squid-cache.org/Doc/config/http_port"><code>http_port</code></a> specifies on which ports Squid will listen for HTTP requests;</li>
<li><a href="http://www.squid-cache.org/Doc/config/http_access"><code>http_access</code></a> specifies access restrictions for HTTP traffic (none, in this case);</li>
<li><a href="http://www.squid-cache.org/Doc/config/cache_peer"><code>cache_peer</code></a> specifies that the Apache web server is listening on port 8080;</li>
<li><a href="http://www.squid-cache.org/Doc/config/acl"><code>acl</code></a> specifies the access list for CernVM-FS: only paths under <code>/cvmfs/*/api/</code> are relevant;</li>
<li><a href="http://www.squid-cache.org/Doc/config/cache"><code>cache</code></a> specifies which paths should be cached by the Squid proxy (only
  paths that match the regular expression on the line above);</li>
<li><a href="http://www.squid-cache_mem.org/Doc/config/cache_mem"><code>cache_mem</code></a> specifies the amount of memory that Squid is allowed to use;</li>
</ul>
<p>For more information, see the Squid documentation: <a href="http://www.squid-cache.org/Doc/config/">http://www.squid-cache.org/Doc/config/</a>.</p>
<h4 id="start-enable-services">Start &amp; enable services<a class="headerlink" href="#start-enable-services" title="Permanent link">&para;</a></h4>
<p>Finally, we start and enable both the Apache and Squid services:</p>
<div class="highlight"><pre><span></span><code>sudo systemctl start httpd
sudo systemctl start squid
sudo systemctl <span class="nb">enable</span> httpd
sudo systemctl <span class="nb">enable</span> squid
</code></pre></div>
<h3 id="314-dns-cache">3.1.4 DNS cache<a class="headerlink" href="#314-dns-cache" title="Permanent link">&para;</a></h3>
<p>As the GeoAPI on a Stratum 1 server does a lot of DNS lookups, it is recommended to have a local DNS caching service on that same
system.</p>
<p>We will not discuss this topic any further here, but you can use <code>dnsmasq</code>, <code>bind</code>, or <code>systemd-resolved</code>.
See for instance <a href="https://geekflare.com/linux-server-local-dns-caching/">this tutorial</a> for setting up <code>systemd-resolved</code>.</p>
<h3 id="315-creating-the-stratum-1-replica">3.1.5 Creating the Stratum 1 replica<a class="headerlink" href="#315-creating-the-stratum-1-replica" title="Permanent link">&para;</a></h3>
<p>With all the required components in place, we can now really set up our Stratum 1 replica server.</p>
<h4 id="create-and-add-geo-api-key-optional">Create and add Geo API key (optional)<a class="headerlink" href="#create-and-add-geo-api-key-optional" title="Permanent link">&para;</a></h4>
<p>We first add our Geo API key to the CernVM-FS server settings, by creating it
and then running these commands:</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> <span class="s1">&#39;CVMFS_GEO_LICENSE_KEY=YOUR_KEY&#39;</span> <span class="p">|</span> sudo tee -a /etc/cvmfs/server.local
sudo chmod <span class="m">600</span> /etc/cvmfs/server.local
</code></pre></div>
<p><em>Replace <code>YOUR_KEY</code> with your Geo API license key; see <a href="https://www.maxmind.com/en/accounts/YOUR_ACCOUNT_ID/license-key">https://www.maxmind.com/en/accounts/YOUR_ACCOUNT_ID/license-key</a>!</em></p>
<p>Note that this is not strictly required for the sake of this tutorial, but it's highly recommended.</p>
<h4 id="add-repository-master-public-key">Add repository master public key<a class="headerlink" href="#add-repository-master-public-key" title="Permanent link">&para;</a></h4>
<p>We also need to have the public master key of each repository we want to mirror to be available on our Stratum 1.</p>
<p>This can be done by copying the <code>.pub</code> file(s) from <code>/etc/cvmfs/keys</code> on the Stratum 0 server to
<code>/etc/cvmfs/keys/organization.tld/</code> (note the extra level!) on the Stratum 1 server, just like we did on the client.</p>
<h4 id="create-replica">Create replica<a class="headerlink" href="#create-replica" title="Permanent link">&para;</a></h4>
<p>Now we make the replica by giving the URL to the repository on the Stratum 0 server
(which is always like <code>http://host:port/cvmfs/repository</code>, with the <code>:port</code> part optional in this tutorial since the default HTTP port 80 is used)
and the path to the corresponding public master key:</p>
<div class="highlight"><pre><span></span><code>sudo cvmfs_server add-replica -o <span class="nv">$USER</span> http://&lt;STRATUM0_IP&gt;/cvmfs/repo.organization.tld /etc/cvmfs/keys/organization.tld/
</code></pre></div>
<p><strong><em>Replace the <code>&lt;STRATUM0_IP&gt;</code> part with the IP address of your Stratum 0 server,
and adjust for the name and domain of your CernVM-FS repository!</em></strong></p>
<p>Executing the <code>add-replica</code> command should produce output reporting on the steps being performed,
and only take a couple of moments to complete.</p>
<p><em>If no output is produced and the command seems to be hanging, make sure that port 80 on your Stratum 0 server
is accessible via the IP address you are using!</em></p>
<h4 id="bypassing-the-geo-api-license-key">Bypassing the Geo API license key<a class="headerlink" href="#bypassing-the-geo-api-license-key" title="Permanent link">&para;</a></h4>
<p>If you prefer not to create a MaxMind account and Geo API license key for the sake of this tutorial,
you can bypass the "<code>CVMFS_GEO_LICENSE_KEY not set</code>" error message
produced by <code>cvmfs_server add-replica</code> by setting the server variable <code>CVMFS_GEO_DB_FILE</code>
to <code>NONE</code> before running the command:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># only do this if you do not want to provide a Geo API key (not recommended!)</span>
<span class="nb">echo</span> <span class="s1">&#39;CVMFS_GEO_DB_FILE=NONE&#39;</span> <span class="p">|</span> sudo tee -a /etc/cvmfs/server.local
</code></pre></div>
<h4 id="remove-the-replica">Remove the replica<a class="headerlink" href="#remove-the-replica" title="Permanent link">&para;</a></h4>
<p>If you ever want to remove the repository replica again, you can use the <code>rmfs</code> subcommand in the same way as on Stratum 0:</p>
<div class="highlight"><pre><span></span><code>sudo cvmfs_server rmfs repo.organization.tld
</code></pre></div>
<h3 id="316-manually-synchronize-the-stratum-1">3.1.6 Manually synchronize the Stratum 1<a class="headerlink" href="#316-manually-synchronize-the-stratum-1" title="Permanent link">&para;</a></h3>
<p>Now that the Stratum 1 has been registered, we should try to do a first synchronization.
You can do this by running the following command:</p>
<p><div class="highlight"><pre><span></span><code>sudo cvmfs_server snapshot repo.organization.tld
</code></pre></div>
As there is not much in the repository yet, this should complete within a few seconds.</p>
<p>The output should end with something like:</p>
<div class="highlight"><pre><span></span><code>Serving revision 2
Fetched 2 new chunks out of 3 processed chunks
</code></pre></div>
<h3 id="317-adding-a-synchronization-cron-job">3.1.7 Adding a synchronization cron job<a class="headerlink" href="#317-adding-a-synchronization-cron-job" title="Permanent link">&para;</a></h3>
<p>Whenever you make changes to the repository, the changes have to be synchronized to all Stratum 1 servers.
This task can be automated by setting up a cron job that periodically runs <code>cvmfs_server snapshot -a</code>, where <code>-a</code> does the synchronization for all active repositories. This option will give an error if no log rotation has been configured for CernVM-FS, so we first have to create a file <code>/etc/logrotate.d/cvmfs</code> with the following contents:</p>
<div class="highlight"><pre><span></span><code>/var/log/cvmfs/*.log {
    weekly
    missingok
    notifempty
}
</code></pre></div>
<p>Now we can make a cron job <code>/etc/cron.d/cvmfs_stratum1_snapshot</code> for the snapshots:</p>
<div class="highlight"><pre><span></span><code>*/5 * * * * root output=$(/usr/bin/cvmfs_server snapshot -a -i 2&gt;&amp;1) || echo &quot;$output&quot;
</code></pre></div>
<h2 id="32-setting-up-a-proxy">3.2 Setting up a proxy<a class="headerlink" href="#32-setting-up-a-proxy" title="Permanent link">&para;</a></h2>
<p>If you have a lot of local machines, e.g. an HPC cluster, that need to access your repositories, you also want another cache layer close to these machines.</p>
<p>This can be done by adding one or more Squid proxies between your local machine(s) and the Stratum 1 server(s).
It is recommended to have at least two proxies, for reliability and load-balancing reasons.</p>
<h3 id="321-requirements">3.2.1 Requirements<a class="headerlink" href="#321-requirements" title="Permanent link">&para;</a></h3>
<p>Just as with the other components, the Squid proxy server does not need a lot of resources.
Just a few cores and few gigabytes of memory should be enough, although extra RAM can be used to cache more content.
Similarly the more disk space you allocate for this machine, the larger the cache can be, and the better the performance will be.</p>
<p>Note that this system will only store a part of the (deduplicated and compressed) repository,
so it does not need as much storage space as the Stratum 0 or Stratum 1 server.</p>
<h3 id="322-installation">3.2.2 Installation<a class="headerlink" href="#322-installation" title="Permanent link">&para;</a></h3>
<p>On the proxy server only Squid needs to be installed:
<div class="highlight"><pre><span></span><code>sudo yum install -y squid
</code></pre></div></p>
<h3 id="323-configuration">3.2.3 Configuration<a class="headerlink" href="#323-configuration" title="Permanent link">&para;</a></h3>
<p>The configuration of a standalone Squid proxy is slightly different from the one that we used for our Stratum 1.</p>
<p>You can use the following <em>template</em> to set up your own Squid configuration for your proxy server (in <code>/etc/squid/squid.conf</code>):</p>
<div class="highlight"><pre><span></span><code># List of local IP addresses (separate IPs and/or CIDR notation) allowed to access your local proxy
acl local_nodes src YOUR_CLIENT_IPS

# Destination domains that are allowed
#acl stratum_ones dstdomain .YOURDOMAIN.ORG
#acl stratum_ones dstdom_regex YOUR_REGEX

# Squid port
http_port 3128

# Deny access to anything which is not part of our stratum_ones ACL.
http_access deny !stratum_ones

# Only allow access from our local machines
http_access allow local_nodes
http_access allow localhost

# Finally, deny all other access to this proxy
http_access deny all

minimum_expiry_time 0
maximum_object_size 1024 MB

cache_mem 128 MB
maximum_object_size_in_memory 128 KB
# 5 GB disk cache
cache_dir ufs /var/spool/squid 5000 16 256
</code></pre></div>
<p>In this template, there are two things you must change in the Access Control List (ACL) settings:</p>
<ul>
<li>
<p>The line starting with <code>acl local_nodes</code> specifies which clients are allowed to use this proxy.
  You can use <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#CIDR_notation">CIDR notation</a>.
  For the sake of this tutorial, you can just replace <code>YOUR_CLIENT_IPS</code> with the IP of your client system.
  For example:
  <div class="highlight"><pre><span></span><code>acl local_nodes src 1.2.3.4
</code></pre></div></p>
</li>
<li>
<p>Add a line starting with <code>acl stratum_ones</code> to specify an ACL for
  the allowed destination domains. 
  For the sake of this tutorial, we can just hardcode this to our Stratum 1 server via <code>dst</code> (destination):
  <div class="highlight"><pre><span></span><code>acl stratum_ones dst &lt;STRATUM1_IP&gt;
</code></pre></div>
  (where you need to change <code>&lt;STRATUM1_IP&gt;</code> with the IP address of your Stratum 1 server)</p>
</li>
</ul>
<p>The <code>stratum_ones</code> ACL you defined is used to specify that the Squid should only cache the Stratum 1 server,
via the first <code>http_access deny</code> line. (Although restricting the destination is not strictly required for functionality,
 this can be beneficial for security to prevent misuse of the proxy server.)</p>
<p>More information about Squid ACLs can be found in the <a href="http://www.squid-cache.org/Doc/config/acl/">Squid documentation</a>.</p>
<p>Finally, there are some settings regarding the size of your cache. Make sure that you have enough disk space for the value that you provide.</p>
<h3 id="324-verifying-squid-configuration">3.2.4 Verifying Squid configuration<a class="headerlink" href="#324-verifying-squid-configuration" title="Permanent link">&para;</a></h3>
<p>To verify the correctness of your Squid configuration, you can run:</p>
<div class="highlight"><pre><span></span><code>sudo squid -k parse
</code></pre></div>
<p>When things look OK (no errors or warnings are printed, exit code zero), you can start and enable Squid.</p>
<h3 id="325-starting-and-enabling-squid">3.2.5 Starting and enabling Squid<a class="headerlink" href="#325-starting-and-enabling-squid" title="Permanent link">&para;</a></h3>
<p>To start and enable Squid, run:</p>
<div class="highlight"><pre><span></span><code>sudo systemctl start squid
sudo systemctl enable squid
</code></pre></div>
<h2 id="33-re-configuring-the-client">3.3 Re-configuring the client<a class="headerlink" href="#33-re-configuring-the-client" title="Permanent link">&para;</a></h2>
<p>Now that we have a Stratum 0 server, a Stratum 1 server, and a Squid proxy,
we have the (minimal) infrastructure in place for a production-ready CernVM-FS setup.</p>
<p>So we can now configure our client properly, and start using the repository.</p>
<p>In the previous section we connected our client directly to the Stratum 0. We are going to reuse that configuration, and only need to change two things.</p>
<h3 id="331-connect-to-the-stratum-1">3.3.1 Connect to the Stratum 1<a class="headerlink" href="#331-connect-to-the-stratum-1" title="Permanent link">&para;</a></h3>
<p>We used the URL of the Stratum 0 in the file <code>/etc/cvmfs/config.d/repo.organization.tld.conf</code>. We should now change this URL, and point to the Stratum 1 instead:
<div class="highlight"><pre><span></span><code>CVMFS_SERVER_URL=&quot;http://&lt;STRATUM1_IP&gt;/cvmfs/@fqrn@&quot;
</code></pre></div></p>
<p><strong><em>Replace the <code>&lt;STRATUM1_IP&gt;</code> part with the IP address of your Stratum 1 server!</em></strong></p>
<p>When you have more Stratum 1 servers inside the organization, you can make it a semicolon-separated list of servers. The Geo API will make sure that your client always connects to the geographically closest Stratum 1 server (if <code>CVMFS_USE_GEOAPI=yes</code>).</p>
<h3 id="332-use-the-squid-proxy">3.3.2 Use the Squid proxy<a class="headerlink" href="#332-use-the-squid-proxy" title="Permanent link">&para;</a></h3>
<p>In order to use the local cache layer of our proxy, we have to instruct the client to send all requests through the proxy.</p>
<p>This needs one small change in <code>/etc/cvmfs/default.local</code>, where you will have to replace <code>DIRECT</code>
with IP address of your Squid proxy service, plus the (default) port 3128 at which Squid is running:
<div class="highlight"><pre><span></span><code>CVMFS_HTTP_PROXY=&quot;http://&lt;PROXY_IP&gt;:3128&quot;
</code></pre></div></p>
<p><strong><em>Replace the <code>&lt;PROXY_IP&gt;</code> part with the IP address of your Squid proxy server!</em></strong></p>
<p>After changing the <code>default.local</code> configuration file, if the repository is currently mounted, do <code>sudo cvmfs_config reload repo.organization.tld</code>
to apply the new configuration. If it is not currently mounted, the updated configuration will be automatically used 
the next time the repository is mounted (you can do <code>ls /cvmfs/repo.organization.tld</code> to cause autofs to mount it).</p>
<p>More proxies can be added to <code>CVMFS_HTTP_PROXY</code> by separating them with a pipe or semicolon symbol.
See the <a href="https://cvmfs.readthedocs.io/en/stable/cpt-configure.html#proxy-list-examples">CernVM-FS documentation</a> for examples.</p>
<h3 id="333-test-the-new-configuration">3.3.3 Test the new configuration<a class="headerlink" href="#333-test-the-new-configuration" title="Permanent link">&para;</a></h3>
<p>Now you can test your new configuration by checking if you can still access the repository. 
Do <code>sudo cvmfs_config chksetup</code> to again test the configuration, 
including access to all configured Stratum 1 servers through all configured proxy servers.
Furthermore, to confirm you are really using your Squid proxy (and to see which if there are more than one), you can do:
<div class="highlight"><pre><span></span><code>cvmfs_config stat -v repo.organization.tld
</code></pre></div></p>
<p>This should show a line that looks like:
<div class="highlight"><pre><span></span><code>Connection: http://&lt;STRATUM1_IP&gt;/cvmfs/repo.organization.tld through proxy http://&lt;PROXY_IP&gt;:3128 (online)
</code></pre></div>
Make sure that it lists your proxy here (and not <code>DIRECT</code>), and that it is marked as <code>online</code>.</p>
<p>If you run into any issues, the <a href="../05_advanced/#debugging-issues">Debugging section on the Advanced topics page</a> may provide some
useful information for finding the cause.</p>
<h2 id="exercise">Exercise<a class="headerlink" href="#exercise" title="Permanent link">&para;</a></h2>
<p>1) Set up a Stratum 1 server. Make sure that it includes:</p>
<ul>
<li>a proper Geo API license key (if you do not want to request an account, you can use the described method to bypass this, but again: do not do this in production!);</li>
<li>cron job for automatically synchronizing the repository (e.g. once every 10 minutes);</li>
<li>properly configured Apache and Squid services;</li>
</ul>
<p>2) Set up a separate Squid proxy. Though it is recommended to at least have two in production, one is enough for now.</p>
<p>3) Reconfigure the client that you set up in the previous section and make sure that it uses your Stratum 1 and Squid proxy.</p>
                
                  
                    

<hr>
<div class="md-source-date">
  <small>
    
      Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">January 27, 2021</span>
    
  </small>
</div>
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../02_stratum0_client/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                2. Stratum 0 and client
              </div>
            </div>
          </a>
        
        
          <a href="../04_publishing/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                4. Publishing
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.53cc9318.min.js"></script>
      <script src="../assets/javascripts/bundle.e9c9f54f.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>